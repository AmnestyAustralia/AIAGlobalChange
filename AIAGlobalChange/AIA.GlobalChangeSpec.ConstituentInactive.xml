<GlobalChangeSpec 
    xmlns="bb_appfx_globalchange"
    xmlns:c="bb_appfx_commontypes"
    ID="a036dbb9-47ad-45f9-85f9-e80cf233fe67"
    Name="Make constituent inactive (AIA)"
    Description="Makes a constituent inactive with the provided inactive reason and description."
    Author="Danny Smith (AIA)"
    DisplayName="Make constituent inactive (AIA)"
    GlobalChangeFolder="Constituent"
    SPName="USR_AIA_USP_GLOBALCHANGE_CONSTITUENTINACTIVE"
    GlobalChangeFolderResourceKey="$$constituent"
    >

  <!-- describe the SP that performs the global change operation -->
  <CreateProcedureSQL>
    <![CDATA[
create procedure dbo.USR_AIA_USP_GLOBALCHANGE_CONSTITUENTINACTIVE
(
  @CHANGEAGENTID uniqueidentifier = null,
  @ASOF as datetime = null,
  @NUMBERADDED int = 0 output,
  @NUMBEREDITED int = 0 output,
  @NUMBERDELETED int = 0 output,
  @IDSETREGISTERID uniqueidentifier,
  @CONSTITUENTINACTIVITYREASONCODEID uniqueidentifier,
  @DETAILS nvarchar(300),
  @UPDATEEXISTINGINACTIVE bit
)
as      
  set nocount off;
  
  declare @CURRENTDATE datetime
  set @CURRENTDATE = getdate();
  set @NUMBERADDED = 0;
  set @NUMBEREDITED = 0;
  set @NUMBERDELETED = 0; 
  
  if @CHANGEAGENTID is null
    exec dbo.USP_CHANGEAGENT_GETORCREATECHANGEAGENT @CHANGEAGENTID output;
          
  declare @SELECTION TABLE (ID UNIQUEIDENTIFIER NOT NULL PRIMARY KEY);
  begin
    insert into @SELECTION (ID) select ID from dbo.UFN_IDSETREADER_GETRESULTS_GUID(@IDSETREGISTERID);        
  end
  
  if exists(
    select 1
    from dbo.IDSETREGISTER
    where ID = @IDSETREGISTERID and STATIC = 1
  )
  begin
    delete @SELECTION
    where ID not in(
    select ID from CONSTITUENT
  )
  end
  
  begin try
    update dbo.CONSTITUENT set
      ISINACTIVE = 1,
      CHANGEDBYID = @CHANGEAGENTID,
      DATECHANGED = @CURRENTDATE
    where ID in (select ID from @SELECTION)

    if @UPDATEEXISTINGINACTIVE = 1
    begin
      update dbo.CONSTITUENTINACTIVEDETAIL set
        CONSTITUENTINACTIVITYREASONCODEID = @CONSTITUENTINACTIVITYREASONCODEID,
        DETAILS = @DETAILS,
        CHANGEDBYID = @CHANGEAGENTID,
        DATECHANGED = @CURRENTDATE
      where ID in (select ID from @SELECTION)
      
      set @NUMBEREDITED = @@ROWCOUNT;
    end
    
    insert into dbo.CONSTITUENTINACTIVEDETAIL (ID, CONSTITUENTINACTIVITYREASONCODEID, DETAILS, ADDEDBYID, CHANGEDBYID, DATEADDED, DATECHANGED)
    select SELECTION.ID, @CONSTITUENTINACTIVITYREASONCODEID, @DETAILS, @CHANGEAGENTID, @CHANGEAGENTID, @CURRENTDATE, @CURRENTDATE
    from @SELECTION as SELECTION where SELECTION.ID not in(select ID from dbo.CONSTITUENTINACTIVEDETAIL);

    set @NUMBERADDED = @@ROWCOUNT;
  end try
  
  begin catch
    exec dbo.USP_RAISE_ERROR;
    return 1;
  end catch
    ]]>
  </CreateProcedureSQL>
  <ExpectedDBExceptions>
    <CustomExceptions xmlns="bb_appfx_commontypes">
      <Exception SearchText="UFN_IDSETREADER_GETRESULTS_GUID" CustomErrorMsgResourceKey="$$an_invalid_selection_was_specified_for_this_global_change">
        <CustomErrorMsg>An invalid selection was specified for this global change.</CustomErrorMsg>
      </Exception>
    </CustomExceptions>
  </ExpectedDBExceptions>
  <ParametersFormMetaData>

    <!-- describe fields on the parameter form, which correspond to parameters on the SP.  Note that system parameters 
    like the context @CHANGEAGENTID, @ASOF, @NUMBERADDED, @NUMBEREDITED, and @NUMBERDELETED need not be listed. -->
    <FormMetaData xmlns="bb_appfx_commontypes">
      <FormFields>
        <FormField FieldID="IDSETREGISTERID" DataType="Guid" Required="true" Caption="Selection" CaptionResourceKey="$$selection">
          <SearchList SearchListID="98d0070e-c4a7-495b-a438-2ac12da79068" EnableQuickFind="true">
            <FormFieldOverrides>
              <FormFieldOverride FieldID="RECORDTYPEID" Caption="Record type" ReadOnly="true" DefaultValueText="Fields!RECORDTYPEID" />
            </FormFieldOverrides>
          </SearchList>
        </FormField>
        <FormField FieldID="RECORDTYPEID" DataType="Guid" ReadOnly="true" Hidden="true" />
        <FormField FieldID="CONSTITUENTINACTIVITYREASONCODEID" DataType="Guid" Required="true" Caption="Reason" CaptionResourceKey="$$reason">
          <SimpleDataList SimpleDataListID="71b29b04-d70f-4d38-bab1-e44a2528d0e8" />
        </FormField>
        <FormField FieldID="DETAILS" MaxLength="300" Caption="Details" CaptionResourceKey="$$details" />
        <FormField FieldID="UPDATEEXISTINGINACTIVE" DataType="Boolean" Caption="Update existing inactive reasons" />
      </FormFields>
      <WebUIComponent>
        <UIModel AssemblyName="AIAGlobalChangeUIModel.dll" ClassName="AIAGlobalChangeUIModel.AIAMakeConstituentInactiveUIModel" />
        <WebUI>
          <ExternalResource Url="browser/htmlforms/custom/AIA/AIAMakeConstituentInactive.html" />
        </WebUI>
      </WebUIComponent>
      <UIActions>
        <UIAction ActionID="EDITQUERY">
          <ShowEditQueryForm LinkedFieldId="IDSETREGISTERID" />
        </UIAction>
      </UIActions>
    </FormMetaData>
  </ParametersFormMetaData>
  
</GlobalChangeSpec>
