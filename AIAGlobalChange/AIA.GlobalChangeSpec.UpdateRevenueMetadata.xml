<GlobalChangeSpec 
    xmlns="bb_appfx_globalchange"
    xmlns:c="bb_appfx_commontypes"
    ID="463b3acb-79a2-4de7-b594-05259926b0c5"
    Name="Update revenue metadata (AIA)"
    Description="Updates revenue marketing metadata fields."
    Author="Danny Smith (AIA)"
    DisplayName="Update revenue metadata (AIA)"
    GlobalChangeFolder="Revenue"
    SPName="USR_AIA_USP_GLOBALCHANGE_UPDATEREVENUE"
    >

  <!-- describe the SP that performs the global change operation -->
  <CreateProcedureSQL>
    <![CDATA[
create procedure dbo.USR_AIA_USP_GLOBALCHANGE_UPDATEREVENUE
(
  @IDSETREGISTERID uniqueidentifier = null,
  @CHANGEAGENTID uniqueidentifier = null,
  @ASOF as datetime = null,
  @NUMBERADDED int = 0 output,
  @NUMBEREDITED int = 0 output,
  @NUMBERDELETED int = 0 output,
  @FINDERNUMBER bigint = null output,
  @SOURCECODE nvarchar(50) = '' output,
  @APPEALID uniqueidentifier = null output,
  @MAILINGID uniqueidentifier = null output,
  @CHANNELCODEID uniqueidentifier = null output
)
as      
  set nocount off;
  
  declare @CURRENTDATE datetime
  set @CURRENTDATE = getdate();
  set @NUMBERADDED = 0;
  set @NUMBEREDITED = 0;
  set @NUMBERDELETED = 0;
  
  if @CHANGEAGENTID is null
    exec dbo.USP_CHANGEAGENT_GETORCREATECHANGEAGENT @CHANGEAGENTID output;
          
  begin try
    update
      rev
    set
      rev.FINDERNUMBER = case when @FINDERNUMBER = 0 or @FINDERNUMBER is null then rev.FINDERNUMBER else @FINDERNUMBER end,
      rev.SOURCECODE = case when @SOURCECODE = '' or @SOURCECODE is null then rev.SOURCECODE else @SOURCECODE end,
      rev.APPEALID = case when @APPEALID is null then rev.APPEALID else @APPEALID end,
      rev.MAILINGID = case when @MAILINGID is null then rev.MAILINGID else @MAILINGID end,
      rev.CHANNELCODEID = case when @CHANNELCODEID is null then rev.CHANNELCODEID else @CHANNELCODEID end

    from
      dbo.[UFN_IDSETREADER_GETRESULTS_GUID](@IDSETREGISTERID) Id
    inner join
      dbo.REVENUE_EXT rev on rev.ID = Id.ID
    set
      @NUMBEREDITED = @@ROWCOUNT;

    --insert records into the recurring gift amendment table.
    insert into dbo.RECURRINGGIFTAMENDMENT (FINANCIALTRANSACTIONID,AMENDMENTTYPECODE,DATE,
                                            SOURCECODE,FINDERNUMBER,APPEALID,MAILINGID,CHANNELCODEID,
                                            ADDEDBYID,CHANGEDBYID,DATEADDED,DATECHANGED)
    select
      rev.ID, 2, @CURRENTDATE,
      SOURCECODE, FINDERNUMBER, APPEALID, MAILINGID, CHANNELCODEID,
      @CHANGEAGENTID, @CHANGEAGENTID, @CURRENTDATE, @CURRENTDATE
    from
      dbo.[UFN_IDSETREADER_GETRESULTS_GUID](@IDSETREGISTERID) Id
    inner join
      dbo.REVENUE rev on rev.ID = Id.ID
    where rev.TRANSACTIONTYPECODE = 2;
  end try
  
  begin catch
    exec dbo.USP_RAISE_ERROR;
    return 1;
  end catch
    ]]>
  </CreateProcedureSQL>

  <ExpectedDBExceptions>
    <CustomExceptions xmlns="bb_appfx_commontypes">
      <Exception SearchText="UFN_IDSETREADER_GETRESULTS_GUID" CustomErrorMsgResourceKey="$$an_invalid_selection_was_specified_for_this_global_change">
        <CustomErrorMsg>An invalid selection was specified for this global change.</CustomErrorMsg>
      </Exception>
    </CustomExceptions>
  </ExpectedDBExceptions>

  <ParametersFormMetaData>
    <FormMetaData xmlns="bb_appfx_commontypes">
      <FormFields>
        <FormField FieldID="IDSETREGISTERID" DataType="Guid" Required="true" Caption="Selection">
          <SearchList SearchListID="98d0070e-c4a7-495b-a438-2ac12da79068" EnableQuickFind="true">
            <FormFieldOverrides>
              <FormFieldOverride FieldID="RECORDTYPEID" Caption="Record type" ReadOnly="true" DefaultValueText="Fields!RECORDTYPEID" />
            </FormFieldOverrides>
          </SearchList>
        </FormField>
        <FormField FieldID="RECORDTYPEID" DataType="Guid" ReadOnly="true" Hidden="true" />
        <FormField FieldID="FINDERNUMBER" DataType="Long" Caption="Finder number" CaptionResourceKey="$$finder_number" DoNotApplyFormat="true" />
        <FormField FieldID="SOURCECODE" MaxLength="50" Caption="Source code" CaptionResourceKey="$$source_code" />
        <FormField FieldID="APPEALID" DataType="Guid" Caption="Appeal" CaptionResourceKey="$$appeal">
          <SearchList SearchListID="a3b8a1b8-3a78-446a-9041-f29c08e2c8c9" EnableQuickFind="true">
            <AddDataForms>
              <AddDataForm ID="2736a8b5-ab2e-4330-ba15-98818321c643" Caption="Add" CaptionResourceKey="$$add" />
            </AddDataForms>
          </SearchList>
        </FormField>
        <FormField FieldID="MAILINGID" DataType="Guid" Caption="Mailing" CaptionResourceKey="$$mailing">
          <SearchList SearchListID="349397cb-e2dd-43e8-a4ca-af5647c91d99" EnableQuickFind="true">
            <FormFieldOverrides>
              <FormFieldOverride FieldID="STATUS" Caption="Status" ReadOnly="true" Hidden="true" DefaultValueText="1" />
              <FormFieldOverride FieldID="INCLUDEAPPEALMAILINGS" Caption="Include appeal mailings" ReadOnly="true" Hidden="true" DefaultValueText="true" />
            </FormFieldOverrides>
          </SearchList>
        </FormField>
        <FormField FieldID="CHANNELCODEID" DataType="Guid" Caption="Channel" CaptionResourceKey="$$channel">
          <CodeTable CodeTableName="CHANNELCODE" />
        </FormField>
      </FormFields>

      <WebUIComponent>
        <UIModel AssemblyName="AIAGlobalChangeUIModel.dll" ClassName="AIAGlobalChangeUIModel.AIAUpdateRevenueMetadataUIModel" />
        <WebUI>
          <ExternalResource Url="browser/htmlforms/custom/AIA/AIAUpdateRevenueMetadata.html" />
        </WebUI>
      </WebUIComponent>
      <UIActions>
        <UIAction ActionID="QUERYEDIT">
          <ShowEditQueryForm LinkedFieldId="IDSETREGISTERID" />
        </UIAction>
      </UIActions>
    </FormMetaData>
  </ParametersFormMetaData>
  
</GlobalChangeSpec>
