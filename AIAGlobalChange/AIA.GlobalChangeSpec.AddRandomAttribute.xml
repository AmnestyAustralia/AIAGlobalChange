<GlobalChangeSpec 
    xmlns="bb_appfx_globalchange"
    xmlns:c="bb_appfx_commontypes"
    ID="77fce359-f45b-4e6f-ad13-3b715cdf9765"
    Name="Add random attribute value (AIA)"
    Description="Adds a random value to an attribute"
    Author="Danny Smith (AIA)"
    DisplayName="Add random attribute value (AIA)"
    GlobalChangeFolder="Attribute"
    SPName="USR_AIA_USP_GLOBALCHANGE_ADDRANDOMATTRIBUTE"
    >

  <!-- describe the SP that performs the global change operation -->
  <CreateProcedureSQL>
    <![CDATA[
create procedure dbo.USR_AIA_USP_GLOBALCHANGE_ADDRANDOMATTRIBUTE
(
  @CHANGEAGENTID uniqueidentifier = null,
  @ASOF as datetime = null,
  @NUMBERADDED int = 0 output,
  @NUMBEREDITED int = 0 output,
  @NUMBERDELETED int = 0 output,
  @RECORDTYPEID uniqueidentifier = null, 
  @IDSETREGISTERID uniqueidentifier = null, 
  @ATTRIBUTECATEGORYID uniqueidentifier,
  @RANDMINVALUE int = null,
  @RANDMAXVALUE int = null,
  @COMMENT nvarchar(255) = null,
  @REMOVEUNQUALIFIED bit,
  @OVERWRITEEXISTINGVALUE bit,
  @STARTDATE datetime = null,
  @ENDDATE datetime = null
)
as      
  set nocount off;

  declare @DATATYPE int
  declare @ATTRIBUTETABLENAME nvarchar(128)
  declare @ONEPERRECORD bit
  declare @VALUECOLUMNNAME nvarchar(128)

  declare @INSERTSQL nvarchar(max) = '', @UPDATESQL nvarchar(max) = '', @DELETESQL nvarchar(max) = '';
  declare @PARAMETERDEFINITION nvarchar(500);

  declare @RANDRANGE int
  set @RANDRANGE = @RANDMAXVALUE - @RANDMINVALUE + 1;

  declare @CURRENTDATE datetime
  set @CURRENTDATE = getdate();
  set @NUMBERADDED = 0;
  set @NUMBEREDITED = 0;
  set @NUMBERDELETED = 0; 

  if @CHANGEAGENTID is null
    exec dbo.USP_CHANGEAGENT_GETORCREATECHANGEAGENT @CHANGEAGENTID output;

  select 
    @DATATYPE = ATTRIBUTECATEGORY.DATATYPECODE, 
    @ATTRIBUTETABLENAME = TABLECATALOG.TABLENAME, 
    @ONEPERRECORD = ATTRIBUTECATEGORY.ONLYALLOWONEPERRECORD,
    @VALUECOLUMNNAME = ATTRIBUTECATEGORY.VALUECOLUMNNAME
  from 
    dbo.ATTRIBUTECATEGORY 
    inner join dbo.TABLECATALOG on TABLECATALOG.ID = ATTRIBUTECATEGORY.TABLECATALOGID 
  where 
    ATTRIBUTECATEGORY.ID = @ATTRIBUTECATEGORYID;

  set @PARAMETERDEFINITION = '@COMMENTPARAMETER nvarchar(255), @CHANGEAGENTIDPARAMETER uniqueidentifier, @CURRENTDATEPARAMETER datetime, @STARTDATEPARAMETER datetime, @ENDDATEPARAMETER datetime';

  declare @SELECTIONTABLESQL nvarchar(2000);
  declare @SELECTION nvarchar(43);
  set @SELECTION = '';

  begin
    select @SELECTION = '##SELECTION' + replace(cast(newid() as nvarchar(36)),'-','')
    set @SELECTIONTABLESQL = 'create table ' + @SELECTION + ' (ID UNIQUEIDENTIFIER NOT NULL PRIMARY KEY, RAND INT NOT NULL);'
    exec sp_executesql @SELECTIONTABLESQL;

    set @SELECTIONTABLESQL = '\
      insert into ' + @SELECTION + ' (ID, RAND) \
      select ID, (((row_number() over (order by newid())) + CAST(ROUND(@RANGEPARAMETER * RAND(), 0) AS INT)) % @RANGEPARAMETER) + @MINVALUEPARAMETER AS RAND \
      from dbo.UFN_IDSETREADER_GETRESULTS_GUID(@IDSETREGISTERIDPARAMETER) SELECTION';

    /* We don't want to include existing records in the random assignment unless we are overwriting them. */
    if @OVERWRITEEXISTINGVALUE = 0 begin
      set @SELECTIONTABLESQL = @SELECTIONTABLESQL + ' where SELECTION.ID not in (select ID from dbo.[' + @ATTRIBUTETABLENAME + '])'
    end

    exec sp_executesql
      @SELECTIONTABLESQL,
      N'@IDSETREGISTERIDPARAMETER uniqueidentifier, @MINVALUEPARAMETER int, @MAXVALUEPARAMETER int, @RANGEPARAMETER int',
      @IDSETREGISTERIDPARAMETER = @IDSETREGISTERID, @MINVALUEPARAMETER = @RANDMINVALUE, @MAXVALUEPARAMETER = @RANDMAXVALUE, @RANGEPARAMETER = @RANDRANGE;
  end

  begin try
    if @ONEPERRECORD = 0
      throw 56666, 'A multi-valued attribute is selected. Only single valued attributes are supported.', 1;

    if @REMOVEUNQUALIFIED = 1 and @IDSETREGISTERID is not null
    begin
      set @DELETESQL = 'delete from dbo.[' + @ATTRIBUTETABLENAME + '] where ID not in (select ID from ' + @SELECTION + ')';

      exec sp_executesql @DELETESQL;
      set @NUMBERDELETED = @@ROWCOUNT;
    end

    if @IDSETREGISTERID is not null
    begin
      set @INSERTSQL = 'insert into dbo.[' + @ATTRIBUTETABLENAME + '] (ID, ' + @VALUECOLUMNNAME + ', ';
      set @INSERTSQL = @INSERTSQL + 'COMMENT, ADDEDBYID, CHANGEDBYID, DATEADDED, DATECHANGED, STARTDATE, ENDDATE) select SELECTION.ID, SELECTION.RAND, ';
      set @INSERTSQL = @INSERTSQL + '@COMMENTPARAMETER, @CHANGEAGENTIDPARAMETER, @CHANGEAGENTIDPARAMETER, @CURRENTDATEPARAMETER, @CURRENTDATEPARAMETER, @STARTDATEPARAMETER, @ENDDATEPARAMETER from ' + @SELECTION + ' as SELECTION';
      
      /* We don't want to add a duplicate attribute value so we need to check if the value already exists before inserting the record. */
      set @INSERTSQL = @INSERTSQL + ' where SELECTION.ID not in (select ID from dbo.[' + @ATTRIBUTETABLENAME + '])'
    
      /* If overwriting the existing value we must only insert records that don't already exist in the attribute table */
      if @OVERWRITEEXISTINGVALUE = 1 begin
        set @UPDATESQL = 'update dbo.[' + @ATTRIBUTETABLENAME + '] set ' + @VALUECOLUMNNAME + ' = SELECTION.RAND, ';
        set @UPDATESQL = @UPDATESQL + 'COMMENT = @COMMENTPARAMETER, CHANGEDBYID = @CHANGEAGENTIDPARAMETER, DATECHANGED = @CURRENTDATEPARAMETER, STARTDATE = @STARTDATEPARAMETER, ENDDATE = @ENDDATEPARAMETER ';
        set @UPDATESQL = @UPDATESQL + 'from dbo.[' + @ATTRIBUTETABLENAME + '] INNER JOIN ' + @SELECTION + ' SELECTION ON [' + @ATTRIBUTETABLENAME + '].ID = SELECTION.ID'
      end
    end

    begin
      if @UPDATESQL <> '' begin
        exec sp_executesql @UPDATESQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
        set @NUMBEREDITED = @@ROWCOUNT;
      end

      exec sp_executesql @INSERTSQL, @PARAMETERDEFINITION,  @COMMENTPARAMETER = @COMMENT, @CHANGEAGENTIDPARAMETER = @CHANGEAGENTID, @CURRENTDATEPARAMETER = @CURRENTDATE, @STARTDATEPARAMETER = @STARTDATE, @ENDDATEPARAMETER = @ENDDATE;
      set @NUMBERADDED = @@ROWCOUNT;
    end
  end try

 
  begin catch
    exec dbo.USP_RAISE_ERROR;
    return 1;
  end catch
    ]]>
  </CreateProcedureSQL>

  <ExpectedDBExceptions>
    <CustomExceptions xmlns="bb_appfx_commontypes">
      <Exception SearchText="UFN_IDSETREADER_GETRESULTS_GUID" CustomErrorMsgResourceKey="$$an_invalid_selection_was_specified_for_this_global_change">
        <CustomErrorMsg>An invalid selection was specified for this global change.</CustomErrorMsg>
      </Exception>
    </CustomExceptions>
  </ExpectedDBExceptions>

  <ParametersFormMetaData>
    <FormMetaData xmlns="bb_appfx_commontypes">
      <FormFields>
        <FormField FieldID="RECORDTYPEID" DataType="Guid" Required="true" Caption="Record type">
          <SimpleDataList SimpleDataListID="86cf30ca-70c4-4cd9-a70f-50814d706b98" />
        </FormField>
        <FormField FieldID="IDSETREGISTERID" DataType="Guid" Required="true" Caption="Selection" CaptionResourceKey="$$selection">
          <SearchList SearchListID="98d0070e-c4a7-495b-a438-2ac12da79068" EnableQuickFind="true">
            <FormFieldOverrides>
              <FormFieldOverride FieldID="RECORDTYPEID" Caption="Record type" ReadOnly="true" DefaultValueText="Fields!RECORDTYPEID" />
            </FormFieldOverrides>
          </SearchList>
        </FormField>
        <FormField FieldID="ATTRIBUTECATEGORYID" DataType="Guid" Required="true" Caption="Category" CaptionResourceKey="$$category">
          <SimpleDataList SimpleDataListID="cb839c08-e56b-480b-a92c-d579c8d95277">
            <Params>
              <Param ID="RECORDTYPEID">
                <Value>Fields!RECORDTYPEID</Value>
              </Param>
            </Params>
          </SimpleDataList>
        </FormField>
        <FormField FieldID="RANDMINVALUE" DataType="Integer" Caption="Minimum value" />
        <FormField FieldID="RANDMAXVALUE" DataType="Integer" Caption="Maximum value" />
        <FormField FieldID="COMMENT" MaxLength="255" Caption="Comment" CaptionResourceKey="$$comment" />
        <FormField FieldID="REMOVEUNQUALIFIED" DataType="Boolean" Caption="Remove attribute from unqualified records" CaptionResourceKey="$$remove_attribute_from_unqualified_records" />
        <FormField FieldID="OVERWRITEEXISTINGVALUE" DataType="Boolean" Caption="Overwrite existing values" DefaultValueText="true" CaptionResourceKey="$$overwrite_existing_values" />
        <FormField FieldID="STARTDATE" DataType="Date" Caption="Start date" CaptionResourceKey="$$start_date" />
        <FormField FieldID="ENDDATE" DataType="Date" Caption="End date" CaptionResourceKey="$$end_date" />
      </FormFields>
      <WebUIComponent>
        <UIModel AssemblyName="AIAGlobalChangeUIModel.dll" ClassName="AIAGlobalChangeUIModel.AIAAddRandomAttributeUIModel" />
        <WebUI>
          <ExternalResource Url="browser/htmlforms/custom/AIA/AIAAddRandomAttribute.html" />
        </WebUI>
      </WebUIComponent>
      <UIActions>
        <UIAction ActionID="QUERYEDIT">
          <ShowEditQueryForm LinkedFieldId="IDSETREGISTERID" />
        </UIAction>
      </UIActions>
    </FormMetaData>
  </ParametersFormMetaData>
</GlobalChangeSpec>
