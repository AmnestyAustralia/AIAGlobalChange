<GlobalChangeSpec 
  xmlns="bb_appfx_globalchange"
  xmlns:c="bb_appfx_commontypes"
  ID="28632080-989b-4d8e-82fc-f1aeb9839f67"
  Name="Start user-defined constituency (AIA)"
  Description="Adds a user-defined constituency to a constituent record with today as the start date"
  Author="Danny Smith (AIA)"
  DisplayName="Start user-defined constituency (AIA)"
  GlobalChangeFolder="Constituent"
  SPName="USR_AIA_USP_GLOBALCHANGE_STARTUSERDEFINEDCONSTITUENCY"
>

  <CreateProcedureSQL>
    <![CDATA[
create procedure dbo.USR_AIA_USP_GLOBALCHANGE_STARTUSERDEFINEDCONSTITUENCY
(
  @IDSETREGISTERID uniqueidentifier = null,
  @CONSTITUENCYCODEID uniqueidentifier,
  @CHANGEAGENTID uniqueidentifier = null,
  @ASOF as datetime = null,
  @REMOVEUNQUALIFIED bit,
  @NUMBERADDED int = 0 output,
  @NUMBEREDITED int = 0 output,
  @NUMBERDELETED int = 0 output
)
as
  set nocount on;

  declare @CURRENTDATE datetime = getdate();
  set @NUMBERADDED = 0;
  set @NUMBEREDITED = 0;
  set @NUMBERDELETED = 0; 

  if @CHANGEAGENTID is null
    exec dbo.USP_CHANGEAGENT_GETORCREATECHANGEAGENT @CHANGEAGENTID output;

  declare @SELECTION TABLE (ID UNIQUEIDENTIFIER NOT NULL PRIMARY KEY);
  begin
    insert into @SELECTION (ID) select ID from dbo.UFN_IDSETREADER_GETRESULTS_GUID(@IDSETREGISTERID);        
  end

  begin try
    if @REMOVEUNQUALIFIED = 1 and @IDSETREGISTERID is not null
    begin
      /* set end date for records */
      update
        dbo.CONSTITUENCY
      set
        DATETO = @CURRENTDATE,
        CHANGEDBYID = @CHANGEAGENTID,
        DATECHANGED = @CURRENTDATE
      from
        dbo.CONSTITUENCY
      where
        CONSTITUENCY.CONSTITUENCYCODEID = @CONSTITUENCYCODEID and
        CONSTITUENCY.DATETO is null and
        CONSTITUENCY.CONSTITUENTID not in (select ID from @SELECTION);

      set @NUMBEREDITED = @@ROWCOUNT;
      
      update
        dbo.CONSTITUENCYDATERANGE
      set
        CONSTITUENCYDATERANGE.DATETO = @CURRENTDATE,
        CONSTITUENCYDATERANGE.DATECHANGED = @CURRENTDATE,
        CONSTITUENCYDATERANGE.CHANGEDBYAPPLICATIONNAME = CHANGEDBY.APPLICATIONNAME,
        CONSTITUENCYDATERANGE.CHANGEDBYUSERNAME = CHANGEDBY.USERNAME,
        CONSTITUENCYDATERANGE.REFRESHDATE = @CURRENTDATE,
        CONSTITUENCYDATERANGE.CONSTITUENCYTS = CONSTITUENCY.TS
      from
        dbo.CONSTITUENCYDATERANGE
      inner join dbo.CONSTITUENCY
        on CONSTITUENCY.ID = CONSTITUENCYDATERANGE.CONSTITUENCYRECORDIDENTIFIER
      inner join dbo.CHANGEAGENT as CHANGEDBY
        on CHANGEDBY.ID = CONSTITUENCY.CHANGEDBYID
      where
        CONSTITUENCYDATERANGE.CONSTITUENCYDEFINITIONID = @CONSTITUENCYCODEID and
        CONSTITUENCYDATERANGE.DATETO is null and
        CONSTITUENCYDATERANGE.CONSTITUENTID not in (select ID from @SELECTION) and
        CONSTITUENCYDATERANGE.CONSTITUENCYTS <> CONSTITUENCY.TS;
    end

    if @IDSETREGISTERID is not null
    begin
      /* if a constituency record exists with today as the end date clear the end date
         instead of creating a new record to avoid violating constraints */
      update
        dbo.CONSTITUENCY
      set
        DATETO = null,
        CHANGEDBYID = @CHANGEAGENTID,
        DATECHANGED = @CURRENTDATE
      from
        dbo.CONSTITUENCY
      where
        CONSTITUENCY.CONSTITUENCYCODEID = @CONSTITUENCYCODEID and
        CONSTITUENCY.DATETO >= CAST(@CURRENTDATE AS DATE) and
        CONSTITUENCY.CONSTITUENTID in (select ID from @SELECTION);

      set @NUMBEREDITED = @NUMBEREDITED + @@ROWCOUNT;
      
      update
        dbo.CONSTITUENCYDATERANGE
      set
        CONSTITUENCYDATERANGE.DATETO = null,
        CONSTITUENCYDATERANGE.DATECHANGED = @CURRENTDATE,
        CONSTITUENCYDATERANGE.CHANGEDBYAPPLICATIONNAME = CHANGEDBY.APPLICATIONNAME,
        CONSTITUENCYDATERANGE.CHANGEDBYUSERNAME = CHANGEDBY.USERNAME,
        CONSTITUENCYDATERANGE.REFRESHDATE = @CURRENTDATE,
        CONSTITUENCYDATERANGE.CONSTITUENCYTS = CONSTITUENCY.TS
      from
        dbo.CONSTITUENCYDATERANGE
      inner join dbo.CONSTITUENCY
        on CONSTITUENCY.ID = CONSTITUENCYDATERANGE.CONSTITUENCYRECORDIDENTIFIER
      inner join dbo.CHANGEAGENT as CHANGEDBY
        on CHANGEDBY.ID = CONSTITUENCY.CHANGEDBYID
      where
        CONSTITUENCYDATERANGE.CONSTITUENCYDEFINITIONID = @CONSTITUENCYCODEID and
        CONSTITUENCYDATERANGE.DATETO >= CAST(@CURRENTDATE AS DATE) and
        CONSTITUENCYDATERANGE.CONSTITUENTID in (select ID from @SELECTION) and
        CONSTITUENCYDATERANGE.CONSTITUENCYTS <> CONSTITUENCY.TS;
    end

    insert into dbo.CONSTITUENCY
    (
      ID,
      CONSTITUENTID,
      CONSTITUENCYCODEID,
      DATEFROM,
      DATETO,
      ADDEDBYID, CHANGEDBYID, DATEADDED, DATECHANGED
    )
    select
      newid(),
      SELECTION.ID,
      @CONSTITUENCYCODEID,
      @CURRENTDATE,
      null,
      @CHANGEAGENTID, @CHANGEAGENTID, @CURRENTDATE, @CURRENTDATE
    from
      @SELECTION as SELECTION
    where
      SELECTION.ID not in (select CONSTITUENTID from dbo.CONSTITUENCY where CONSTITUENCY.CONSTITUENCYCODEID = @CONSTITUENCYCODEID and CONSTITUENCY.DATETO is null);

    set @NUMBERADDED = @@ROWCOUNT;

    insert into dbo.CONSTITUENCYDATERANGE
    (
      ID,
      CONSTITUENTID,
      CONSTITUENCYDEFINITIONID,
      DATEFROM,
      DATETO,
      CONSTITUENCYRECORDIDENTIFIER,
      REFRESHDATE,
      DATEADDED,
      DATECHANGED,
      ADDEDBYAPPLICATIONNAME,
      ADDEDBYUSERNAME,
      CHANGEDBYAPPLICATIONNAME,
      CHANGEDBYUSERNAME,
      CONSTITUENCYTS
    )
    select
      newid(),
      CONSTITUENCY.CONSTITUENTID,
      @CONSTITUENCYCODEID,
      CONSTITUENCY.DATEFROM,
      null,
      CONSTITUENCY.ID,
      @CURRENTDATE,
      @CURRENTDATE,
      @CURRENTDATE,
      ADDEDBY.APPLICATIONNAME,
      ADDEDBY.USERNAME,
      CHANGEDBY.APPLICATIONNAME,
      CHANGEDBY.USERNAME,
      CONSTITUENCY.TS
    from
      dbo.CONSTITUENCY
    left join dbo.CONSTITUENCYDATERANGE
      on CONSTITUENCYDATERANGE.CONSTITUENCYRECORDIDENTIFIER = CONSTITUENCY.ID
    inner join dbo.CHANGEAGENT as ADDEDBY
      on ADDEDBY.ID = CONSTITUENCY.ADDEDBYID
    inner join dbo.CHANGEAGENT as CHANGEDBY
      on CHANGEDBY.ID = CONSTITUENCY.CHANGEDBYID
    where
      CONSTITUENCYDATERANGE.ID is null and
      CONSTITUENCY.DATETO is null and
      CONSTITUENCY.CONSTITUENCYCODEID = @CONSTITUENCYCODEID;
  end try

  begin catch
    exec dbo.USP_RAISE_ERROR;
    return 1;
  end catch
    ]]>
  </CreateProcedureSQL>

  <ExpectedDBExceptions>
    <CustomExceptions xmlns="bb_appfx_commontypes">
      <Exception SearchText="UFN_IDSETREADER_GETRESULTS_GUID" CustomErrorMsgResourceKey="$$an_invalid_selection_was_specified_for_this_global_change">
        <CustomErrorMsg>An invalid selection was specified for this global change.</CustomErrorMsg>
      </Exception>
    </CustomExceptions>
  </ExpectedDBExceptions>

  <ParametersFormMetaData>
    <FormMetaData xmlns="bb_appfx_commontypes">
      <FormFields>
        <FormField FieldID="IDSETREGISTERID" DataType="Guid" Required="true" Caption="Selection" CaptionResourceKey="$$selection">
          <SearchList SearchListID="98d0070e-c4a7-495b-a438-2ac12da79068" EnableQuickFind="true">
            <FormFieldOverrides>
              <FormFieldOverride FieldID="RECORDTYPEID" Caption="Record type" ReadOnly="true" DefaultValueText="Fields!RECORDTYPEID" />
            </FormFieldOverrides>
          </SearchList>
        </FormField>
        <FormField FieldID="CONSTITUENCYCODEID" DataType="Guid" Required="true" Caption="Constituency" CaptionResourceKey="$$constituency">
          <CodeTable CodeTableName="CONSTITUENCYCODE" />
        </FormField>
        <FormField FieldID="RECORDTYPEID" DataType="Guid" ReadOnly="true" Hidden="true" />
        <FormField FieldID="REMOVEUNQUALIFIED" DataType="Boolean" DefaultValueText="" Caption="End constituency for unqualified records" />
      </FormFields>

      <WebUIComponent>
        <UIModel AssemblyName="AIAGlobalChangeUIModel.dll" ClassName="AIAGlobalChangeUIModel.AIAStartUserDefinedConstituencyUIModel" />
        <WebUI>
          <ExternalResource Url="browser/htmlforms/custom/AIA/AIAStartUserDefinedConstituency.html" />
        </WebUI>
      </WebUIComponent>
      <UIActions>
        <UIAction ActionID="QUERYEDIT">
          <ShowEditQueryForm LinkedFieldId="IDSETREGISTERID" />
        </UIAction>
      </UIActions>
    </FormMetaData>
  </ParametersFormMetaData>
  
</GlobalChangeSpec>
